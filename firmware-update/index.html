<!-- 
 Adapted from webdfu by Devan Lai
 Copyright (c) 2016, Devan Lai
 Licensed under the ISC License
-->

<!-- to do:
 geen cursor circle over inputveld  -->

<!DOCTYPE html>
<html>
  <head>
    <title>Firmware Updates - Butterfly Effects</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="../assets/butterflyeffects_logo.svg"
    />
    <link rel="stylesheet" href="../style.css" />
    <script src="dfu.js"></script>
    <script src="dfuse.js"></script>
    <script src="FileSaver.js"></script>
    <script src="dfu-util.js"></script>
  </head>
  <body class="extra-page-body">
    <div class="circle"></div>
    <header class="extra-page-header">
      <div class="site-logo">
        <a href="https://butterflyeffects.world"
          ><img src="../assets/butterflyeffects_typelogo.svg" alt=""
        /></a>
      </div>
      <button class="firm-button" id="connect">Connect</button>
    </header>
    <main>
      <p><span id="status"></span></p>
      <div>
        <label class="hidden" for="vid">Vendor ID (hex):</label>
        <input
          list="vendor_ids"
          type="hidden"
          name="vid"
          id="vid"
          maxlength="6"
          size="8"
          pattern="0x[A-Fa-f0-9]{1,4}"
        />
        <datalist id="vendor_ids">
          <option value="0x1209">dapboot DFU bootloader</option>
          <option value="0x0D28">mbed DAPLink</option>
          <option value="0x1EAF">LeafLabs Maple/stm32duino bootloader</option>
        </datalist>
      </div>

      <dialog id="interfaceDialog">
        Your device has multiple DFU interfaces. Select one from the list below:
        <form id="interfaceForm" method="dialog">
          <button id="selectInterface" type="submit">Select interface</button>
        </form>
      </dialog>
      <div>
        <div class="hidden" id="usbInfo" style="white-space: pre"></div>
        <div class="hidden" id="dfuInfo" style="white-space: pre"></div>
      </div>
      <fieldset class="hidden" id="runtimeSection">
        <legend>Runtime mode</legend>
        <button id="detach" disabled="true">Detach DFU</button>
      </fieldset>
      <fieldset>
        <form id="configForm">
          <div class="hidden">
            <label for="transferSize">Transfer Size:</label>
            <input
              type="number"
              name="transferSize"
              id="transferSize"
              value="1024"
            />
          </div>
          <div class="hidden" id="dfuseFields">
            <label for="dfuseStartAddress">DfuSe Start Address:</label>
            <input
              type="text"
              name="dfuseStartAddress"
              id="dfuseStartAddress"
              title="Initial memory address to read/write from (hex)"
              size="10"
              pattern="0x[A-Fa-f0-9]+"
            />
            <label for="dfuseUploadSize">DfuSe Upload Size:</label>
            <input
              type="number"
              name="dfuseUploadSize"
              id="dfuseUploadSize"
              min="1"
            />
          </div>

          <!--legend>DFU mode</legend-->
          <fieldset class="firm-section">
            <legend>Firmware Download</legend>
            <!--input type="file" id="firmwareFile" name="file" disabled="true" /-->
             <select id="firmwareSelect" class="firm-select">
              <option value="/firmwares/Dobbo_v1.2_batchAB.bin">Dobbo v1.2 Batch A/B</option>
              <option value="/firmwares/Dobbo_v1.2_batchC.bin">Dobbo v1.2 Batch C</option>
            </select>

            <br />
            
            <button class="firm-button" id="download" disabled="true">
              Download
            </button>
            <div class="log" id="downloadLog"></div>
          </fieldset>

          <fieldset class="hidden" id="uploadSection">
            <legend>Firmware Upload (read from USB device)</legend>
            <button id="upload" disabled="true">Upload</button>
            <div class="log" id="uploadLog"></div>
          </fieldset>
        </form>
      </fieldset>

      <div class="firm-section">
        <legend id="update-instructions-legend">
          Firmware Update Instructions
        </legend>
        <ol id="update-instructions">
          <li>
            Connect Dobbo to your computer using a usb-c cable while Dobbo is
            powered&nbsp;off.
          </li>
          <li>
            Power on Dobbo while holding both led buttons until they start
            blinking&nbsp;red.
          </li>
          <li>Press the preset button to enter firmware update&nbsp;mode.</li>
          <li>
            Press the Connect button and select 'FS in DFU mode' from
            the&nbsp;list.
          </li>
          <li>
            Select the .bin file for your
            batch number from the dropdown&nbsp;list.
          </li>
          <li>Press Download and wait for the progress bars to&nbsp;finish.</li>
          <li>
            Unplug the power and usb-c cables from Dobbo and perform a
            factory&nbsp;reset.
          </li>
          <li>Now, you can use Dobbo with it's new&nbsp;firmware!</li>
        </ol>
      </div>
    </main>
    <script src="../cursor.js"></script>
  </body>
</html>
